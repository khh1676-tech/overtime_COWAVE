<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ˆê³¼ê·¼ë¬´ ê³„ì‚°ê¸°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      min-height: 100vh;
      padding: 20px 20px 40px 20px;
      color: #1a202c;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-card {
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 48px 40px;
      max-width: 450px;
      width: 100%;
      text-align: center;
    }
    .login-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin: 0 auto 24px;
      box-shadow: 0 10px 30px rgba(0, 102, 255, 0.3);
    }
    .login-title {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }
    .login-subtitle {
      color: #718096;
      font-size: 15px;
      margin-bottom: 32px;
      line-height: 1.6;
    }
    .login-input-group {
      margin-bottom: 24px;
      text-align: left;
    }
    .login-input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .login-input-group input {
      width: 100%;
      padding: 16px 20px;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .login-input-group input:focus {
      outline: none;
      border-color: #0066FF;
      background: white;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    .login-button {
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
    }
    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 102, 255, 0.6);
    }
    .login-help {
      margin-top: 20px;
      font-size: 13px;
      color: #a0aec0;
    }
    
    /* ë©”ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
    .main-screen {
      display: none;
    }
    .page-title {
      text-align: center;
      font-size: 48px;
      font-weight: 900;
      color: white;
      margin-bottom: 32px;
      text-shadow: 0 4px 12px rgba(0,0,0,0.2);
      letter-spacing: -1px;
    }
    .user-info {
      background: white;
      border-radius: 16px;
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .user-name {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
    }
    .user-name span {
      color: #0066FF;
    }
    .logout-button {
      padding: 8px 16px;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .logout-button:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }
    .header {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 32px;
      margin-bottom: 24px;
      text-align: center;
    }
    .header h1 { 
      font-size: 32px; 
      font-weight: 800; 
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    .header p { color: #718096; font-size: 14px; }
    .main-grid { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 24px; 
    }
    .top-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 24px;
      margin-bottom: 24px;
    }
    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #f7fafc;
    }
    .icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    .card-header h2 { font-size: 20px; font-weight: 700; color: #2d3748; }
    .input-group { margin-bottom: 20px; }
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .input-container { position: relative; }
    .input-container input {
      width: 100%;
      padding: 14px 16px;
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s;
    }
    .input-container input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .input-unit {
      position: absolute;
      right: 16px;
      top: 14px;
      color: #a0aec0;
      font-size: 14px;
      font-weight: 600;
    }
    .summary-item {
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 102, 255, 0.3);
      height: 164px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .summary-label { 
      font-size: 14px; 
      font-weight: 600; 
      color: rgba(255,255,255,0.9);
      margin-bottom: 8px;
    }
    .summary-value {
      font-size: 36px; 
      font-weight: 800;
      color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      margin-bottom: 12px;
    }
    .summary-message {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.95);
      line-height: 1.4;
      margin-top: 8px;
    }
    .month-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0;
      height: 100%;
    }
    .month-navigation button {
      display: none;
    }
    .month-display {
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
      width: 100%;
      text-align: center;
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(0, 102, 255, 0.1) 0%, rgba(0, 199, 60, 0.1) 100%);
      border-radius: 12px;
      border: 2px solid rgba(0, 102, 255, 0.3);
    }
    .table-container { overflow-x: auto; }
    .work-table { width: 100%; border-collapse: collapse; }
    .work-table th {
      background: #f7fafc;
      padding: 14px 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 700;
      color: #4a5568;
      border-bottom: 2px solid #e2e8f0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
    }
    .work-table td {
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #f7fafc;
      font-size: 14px;
    }
    .work-table tbody tr:hover { background: #f7fafc; }
    .work-input {
      width: 90px;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .work-input:focus {
      outline: none;
      border-color: #0066FF;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    .work-input:disabled {
      background: #edf2f7;
      color: #a0aec0;
      cursor: not-allowed;
    }
    select {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
    }
    select:focus {
      outline: none;
      border-color: #0066FF;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    .row-annual-leave { background-color: #fef3c7 !important; }
    .row-annual-leave input { background-color: #fde68a !important; }
    .row-work-from-home { background-color: #dbeafe !important; }
    .row-work-from-home input { background-color: #93c5fd !important; }
    .row-holiday { background-color: #fecaca !important; }
    .row-holiday input { background-color: #fca5a5 !important; }
    .total-row {
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      border-top: 3px solid #0066FF;
    }
    .total-row td { 
      font-weight: 800; 
      padding: 16px;
      color: white;
      font-size: 16px;
    }
    .controls { 
      display: flex; 
      gap: 12px; 
      margin-bottom: 16px; 
      flex-wrap: wrap; 
    }
    button {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all 0.3s;
      letter-spacing: 0.5px;
    }
    button.primary { 
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
    }
    button.primary:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 102, 255, 0.6);
    }
    button.secondary { 
      background: #f7fafc; 
      color: #4a5568;
      border: 2px solid #e2e8f0;
    }
    button.secondary:hover { 
      background: #edf2f7;
      border-color: #cbd5e0;
    }
    .footer {
      text-align: center;
      margin-top: 32px;
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }
    .footer p {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
      z-index: 9999;
      animation: slideIn 0.3s ease-out;
    }
    .toast.success {
      border-left: 4px solid #00C73C;
      color: #00C73C;
    }
    .toast.error {
      border-left: 4px solid #ef4444;
      color: #ef4444;
    }
    .toast.hide {
      animation: slideOut 0.3s ease-out forwards;
    }

    /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
    .tooltip {
      position: absolute;
      background: linear-gradient(135deg, #0066FF 0%, #00C73C 100%);
      color: white;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 102, 255, 0.4);
      z-index: 1000;
      white-space: nowrap;
      animation: tooltipBounce 0.5s ease-in-out;
      pointer-events: none;
      right: -180px;
      top: 50%;
      transform: translateY(-50%);
    }
    .tooltip::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid #0066FF;
    }
    @keyframes tooltipBounce {
      0%, 100% { transform: translateY(-50%) translateX(0); }
      50% { transform: translateY(-50%) translateX(5px); }
    }
    .tooltip-fade-out {
      animation: tooltipFadeOut 0.5s ease-out forwards;
    }
    @keyframes tooltipFadeOut {
      to { 
        opacity: 0;
        transform: translateY(-50%) translateX(10px);
      }
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    @media (max-width: 1024px) { 
      .main-grid { grid-template-columns: 1fr; }
      .top-section { grid-template-columns: 1fr; }
      .header h1 { font-size: 24px; }
      .page-title { font-size: 36px; margin-bottom: 24px; }
      body { padding: 16px 16px 60px 16px; }
      .footer { margin-bottom: 40px; }
      .login-card { padding: 32px 24px; }
      .login-title { font-size: 28px; }
      .toast {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        top: 20px;
        max-width: 90%;
      }
      .tooltip {
        right: auto;
        left: 50%;
        top: auto;
        bottom: -50px;
        transform: translateX(-50%);
      }
      .tooltip::before {
        left: 50%;
        top: -8px;
        transform: translateX(-50%);
        border-right: 8px solid transparent;
        border-left: 8px solid transparent;
        border-bottom: 8px solid #0066FF;
      }
      @keyframes tooltipBounce {
        0%, 100% { transform: translateX(-50%) translateY(0); }
        50% { transform: translateX(-50%) translateY(5px); }
      }
      @keyframes slideIn {
        from {
          transform: translateX(-50%) translateY(-100px);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
        to {
          transform: translateX(-50%) translateY(-100px);
          opacity: 0;
        }
      }
    }
  </style>
</head>
<body>
  <!-- ë¡œê·¸ì¸ í™”ë©´ -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-icon">ğŸ‘¤</div>
      <h1 class="login-title">ì´ˆê³¼ê·¼ë¬´ ê³„ì‚°ê¸°</h1>
      <p class="login-subtitle">ì´ë¦„ì„ ì…ë ¥í•˜ì‹œë©´<br>ì–´ë””ì„œë“  ë‚˜ì˜ ê·¼ë¬´ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!</p>
      <div class="login-input-group">
        <label for="userName">ì´ë¦„</label>
        <input type="text" id="userName" placeholder="ì˜ˆ: ê¹€í™˜í¬" autocomplete="off">
      </div>
      <button class="login-button" onclick="login()">ì‹œì‘í•˜ê¸°</button>
      <p class="login-help">ğŸ’¡ ì…ë ¥í•œ ì´ë¦„ìœ¼ë¡œ ë°ì´í„°ê°€ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤</p>
    </div>
  </div>

  <!-- ë©”ì¸ í™”ë©´ -->
  <div class="main-screen" id="mainScreen">
    <div class="container">
      <h1 class="page-title">ì´ˆê³¼ê·¼ë¬´ ê³„ì‚°ê¸°</h1>
      
      <div class="user-info">
        <div class="user-name"><span id="displayUserName"></span>ë‹˜ì˜ ê·¼ë¬´ í˜„í™©</div>
        <button class="logout-button" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <div class="top-section">
        <div class="card">
          <div class="card-header">
            <div class="icon">ğŸ“ˆ</div>
            <h2>ì›”ê°„ ìš”ì•½</h2>
          </div>
          <div class="summary-item">
            <div class="summary-label">ì´ ì´ˆê³¼ê·¼ë¬´</div>
            <div class="summary-value" id="overtimeDisplay">00:00</div>
            <div class="summary-message" id="overtimeMessage">ì˜¤ëŠ˜ë„ í™”ì´íŒ…!</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="icon">ğŸ“…</div>
            <h2>í˜„ì¬ ì›”</h2>
          </div>
          <div class="summary-item">
            <div class="summary-label">í˜„ì¬ ë‚ ì§œ</div>
            <div class="summary-value" id="monthDisplay">2025ë…„ 12ì›”</div>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <div class="card">
            <div class="card-header">
              <div class="icon">ğŸ“…</div>
              <h2>ì¼ë³„ ê·¼ë¬´ ê¸°ë¡</h2>
            </div>
            <div class="table-container">
              <table class="work-table" id="workTable">
                <thead>
                  <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ìš”ì¼</th>
                    <th style="position: relative;">
                      ê·¼ë¡œì‹œê°„
                      <span id="tooltipAnchor"></span>
                    </th>
                    <th>ê·¼ë¬´í˜•íƒœ</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr class="total-row">
                    <td colspan="4" id="totalHoursRow">ì´ ê·¼ë¡œ ì‹œê°„: 00:00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>ë¬¸ì˜ì‚¬í•­ ğŸ‘‰ ë§ˆì¼€íŒ…ì „ëµíŒ€ ê¹€í™˜í¬</p>
      </div>
    </div>
  </div>

<script>
  const weekdayKo = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth() + 1;
  let currentUser = "";
  let autoSaveTimer = null;
  let hasShownTooltip = false;
  
  // ë¡œê·¸ì¸ ì²˜ë¦¬
  async function login() {
    const userName = document.getElementById('userName').value.trim();
    if (!userName) {
      showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
      return;
    }
    
    currentUser = userName;
    document.getElementById('displayUserName').textContent = userName;
    
    // í™”ë©´ ì „í™˜
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainScreen').style.display = 'block';
    
    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìë™)
    await loadDataFromCloud();
    
    showToast(`${userName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
    
    // íˆ´íŒ í‘œì‹œ (ì²˜ìŒ ë¡œê·¸ì¸ì‹œì—ë§Œ)
    if (!hasShownTooltip) {
      setTimeout(showTooltip, 800);
      hasShownTooltip = true;
    }
  }
  
  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
  function logout() {
    if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      currentUser = "";
      hasShownTooltip = false;
      document.getElementById('userName').value = "";
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainScreen').style.display = 'none';
      showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
    }
  }
  
  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
  function showToast(message, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
      existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span style="font-size: 20px;">${type === 'success' ? 'âœ”' : 'âš '}</span>
      <span>${message}</span>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('hide');
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // íˆ´íŒ í‘œì‹œ í•¨ìˆ˜
  function showTooltip() {
    const anchor = document.getElementById('tooltipAnchor');
    if (!anchor) return;

    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = 'ê·¼ë¡œ ì‹œê°„ì„ ì±„ì›Œì£¼ì„¸ìš”';
    
    anchor.style.position = 'relative';
    anchor.appendChild(tooltip);
    
    setTimeout(() => {
      tooltip.classList.add('tooltip-fade-out');
      setTimeout(() => tooltip.remove(), 500);
    }, 3000);
  }
  
  // í˜ì´ì§€ ë¡œë“œì‹œ í˜„ì¬ ì›”ë¡œ ìë™ ì„¤ì •
  function initializeCurrentMonth() {
    const now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth() + 1;
    updateMonthDisplay();
    generateMonth(currentYear, currentMonth);
  }
  
  function getKoreanHolidays(year) {
    const holidays = [];
    holidays.push(`${year}-01-01`);
    holidays.push(`${year}-03-01`);
    holidays.push(`${year}-05-05`);
    holidays.push(`${year}-06-06`);
    holidays.push(`${year}-08-15`);
    holidays.push(`${year}-10-03`);
    holidays.push(`${year}-10-09`);
    holidays.push(`${year}-12-25`);
    
    if (year === 2025) {
      holidays.push('2025-01-28','2025-01-29','2025-01-30');
      holidays.push('2025-05-05');
      holidays.push('2025-10-05','2025-10-06','2025-10-07','2025-10-08');
    }
    return holidays;
  }
  
  function isHoliday(year, month, day) {
    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    return getKoreanHolidays(year).includes(dateStr);
  }
  
  function updateMonthDisplay() {
    document.getElementById('monthDisplay').textContent = `${currentYear}ë…„ ${currentMonth}ì›”`;
  }

  function generateMonth(year, month) {
    const tbody = document.querySelector("#workTable tbody");
    tbody.innerHTML = "";
    const lastDay = new Date(year, month, 0).getDate();

    for (let d = 1; d <= lastDay; d++) {
      const dateObj = new Date(year, month - 1, d);
      const day = dateObj.getDay();
      if (day === 0 || day === 6 || isHoliday(year, month, d)) continue;

      const mmdd = String(month).padStart(2,"0") + "-" + String(d).padStart(2,"0");
      const tr = document.createElement("tr");
      const isFriday = day === 5;
      const hoursVal = "08:00";
      const typeVal = isFriday ? "ì¬íƒ(ê¸ˆ)" : "ì •ìƒ";

      tr.innerHTML = `
        <td>${mmdd}</td>
        <td>${weekdayKo[day]}</td>
        <td><input type="text" class="work-input" value="${hoursVal}" ${isFriday ? "readonly" : ""}></td>
        <td>
          <select>
            <option ${typeVal==='ì •ìƒ'?'selected':''}>ì •ìƒ</option>
            <option ${typeVal==='ì—°ì°¨'?'selected':''}>ì—°ì°¨</option>
            <option ${typeVal==='ì¬íƒ(ê¸ˆ)'?'selected':''}>ì¬íƒ(ê¸ˆ)</option>
            <option ${typeVal==='íœ´ì¼'?'selected':''}>íœ´ì¼</option>
          </select>
        </td>`;

      const input = tr.querySelector("input");
      const select = tr.querySelector("select");
      input.addEventListener("blur", e => { e.target.value = normalizeTime(e.target.value); autoSave(); });
      input.addEventListener("input", () => autoSave());
      select.addEventListener("change", () => { updateType(tr); autoSave(); });
      tbody.appendChild(tr);
      updateType(tr);
    }
    calculate();
  }

  function updateType(tr) {
    const select = tr.querySelector("select");
    const input = tr.querySelector("input");
    const type = select.value;
    tr.classList.remove('row-annual-leave','row-work-from-home','row-holiday');

    if (type === "ì—°ì°¨") {
      input.value = "08:00";
      input.setAttribute("readonly", true);
      tr.classList.add('row-annual-leave');
    } else if (type === "ì¬íƒ(ê¸ˆ)") {
      input.value = "08:00";
      input.setAttribute("readonly", true);
      tr.classList.add('row-work-from-home');
    } else if (type === "íœ´ì¼") {
      input.value = "00:00";
      input.setAttribute("readonly", true);
      tr.classList.add('row-holiday');
    } else {
      input.removeAttribute("readonly");
    }
    calculate();
  }

  function normalizeTime(val) {
    if (!val) return "00:00";
    val = val.replace(/[^0-9]/g,"");
    if (val.length <= 2) return val.padStart(2,"0") + ":00";
    if (val.length === 3) return val.slice(0,1).padStart(2,"0") + ":" + val.slice(1).padStart(2,"0");
    return val.slice(0,-2).padStart(2,"0") + ":" + val.slice(-2);
  }

  function timeToMinutes(timeStr) {
    if (!timeStr || !timeStr.includes(":")) return 0;
    const [h,m] = timeStr.split(":").map(Number);
    return h * 60 + m;
  }

  function minutesToTime(minutes) {
    const sign = minutes < 0 ? "-" : "";
    const abs = Math.abs(minutes);
    const h = Math.floor(abs / 60);
    const m = abs % 60;
    return `${sign}${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function calculate() {
    let totalMinutes = 0;
    let overtimeMinutes = 0;

    document.querySelectorAll("#workTable tbody tr").forEach(tr => {
      const type = tr.querySelector("select").value;
      if (type === "íœ´ì¼") return;
      const minutes = timeToMinutes(tr.children[2].querySelector("input").value);
      totalMinutes += minutes;
      overtimeMinutes += (minutes - 480);
    });

    document.getElementById("totalHoursRow").innerText = `ì´ ê·¼ë¡œ ì‹œê°„: ${minutesToTime(totalMinutes)}`;
    const overtimeEl = document.getElementById("overtimeDisplay");
    overtimeEl.textContent = minutesToTime(overtimeMinutes);
    
    // ë§ˆì´ë„ˆìŠ¤ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
    if (overtimeMinutes < 0) {
      overtimeEl.style.color = '#ff4444';
      overtimeEl.parentElement.style.background = 'linear-gradient(135deg, #ff4444 0%, #cc0000 100%)';
    } else {
      overtimeEl.style.color = 'white';
      overtimeEl.parentElement.style.background = 'linear-gradient(135deg, #0066FF 0%, #00C73C 100%)';
    }
    
    const messageEl = document.getElementById("overtimeMessage");
    let message = "";
    
    if (overtimeMinutes === 0) {
      message = "ì •ì‹œí‡´ê·¼ ë¯¸ì³¤ê³ !ğŸ‰";
    } else if (overtimeMinutes > 0 && overtimeMinutes <= 30) {
      message = "ì´ê±° ê°€ì§€ê³  ë¹¨ë¦¬ í‡´ê·¼ í•  ìˆ˜ ì—†ì–´ìš”! ë” ì±„ì›Œì£¼ì„¸ìš”ğŸ’ª";
    } else if (overtimeMinutes > 30 && overtimeMinutes <= 60) {
      message = "í•˜ë£¨ëŠ” ì¢€ ë¹¨ë¦¬ í‡´ê·¼í•˜ì‹œì£ ? ğŸ˜Š";
    } else if (overtimeMinutes > 60 && overtimeMinutes <= 120) {
      message = "ë„ˆë¬´ ë§ì´ ìŒ“ì•˜ë‹¤! ë¹¨ë¦¬ í‡´ê·¼í•´ìš”! ğŸŒŸ";
    } else if (overtimeMinutes > 120) {
      message = "4ì‹œì— ê°€ë„ ëœë‹¤ ì´ê±°ëŠ” ã…‡ã…ˆ? ğŸ”¥";
    } else if (overtimeMinutes >= -30 && overtimeMinutes < 0) {
      message = "ì˜¤ëŠ˜ ì¡°ê¸ˆë§Œ ì±„ìš°ê³  ê°€ì‹œì£ ? ğŸ’ª";
    } else if (overtimeMinutes >= -60 && overtimeMinutes < -30) {
      message = "ì‚´ì§ ìœ„ê¸° ì˜¬ ê²ƒ ê°™ì€ë..? ğŸ¤”";
    } else if (overtimeMinutes >= -120 && overtimeMinutes < -60) {
      message = "ì´ê±´ ì¢€... ë¹„ìƒ!!!!!!ğŸª«";
    } else if (overtimeMinutes < -120) {
      message = "ì˜¤ëŠ˜ ì§‘ì— ëª»ë“¤ì–´ê°„ë‹¤ê³  ì—°ë½í•˜ì„¸ìš” ã…..âŒš";
    }
    
    messageEl.textContent = message;
  }

  // ìë™ ì €ì¥ í•¨ìˆ˜
  function autoSave() {
    calculate();
    
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(async () => {
      await saveDataToCloud();
    }, 1000);
  }

  // í´ë¼ìš°ë“œì— ë°ì´í„° ì €ì¥ (ìë™)
  async function saveDataToCloud() {
    if (!currentUser) return;
    
    try {
      const rows = [];
      
      document.querySelectorAll("#workTable tbody tr").forEach(tr => {
        rows.push({
          date: tr.children[0].textContent,
          weekday: tr.children[1].textContent,
          hours: tr.children[2].querySelector("input").value,
          type: tr.children[3].querySelector("select").value
        });
      });
      
      const data = { 
        year: currentYear, 
        month: currentMonth, 
        rows,
        lastSaved: new Date().toISOString()
      };
      
      const storageKey = `overtime_${currentUser}_${currentYear}_${currentMonth}`;
      
      // window.storageê°€ ì—†ìœ¼ë©´ localStorage ì‚¬ìš©
      if (typeof window.storage !== 'undefined') {
        await window.storage.set(storageKey, JSON.stringify(data), true);
      } else {
        localStorage.setItem(storageKey, JSON.stringify(data));
      }
    } catch (error) {
      console.error('Auto-save error:', error);
      // localStorageë¡œ fallback
      try {
        const storageKey = `overtime_${currentUser}_${currentYear}_${currentMonth}`;
        const data = { 
          year: currentYear, 
          month: currentMonth, 
          rows: [],
          lastSaved: new Date().toISOString()
        };
        document.querySelectorAll("#workTable tbody tr").forEach(tr => {
          data.rows.push({
            date: tr.children[0].textContent,
            weekday: tr.children[1].textContent,
            hours: tr.children[2].querySelector("input").value,
            type: tr.children[3].querySelector("select").value
          });
        });
        localStorage.setItem(storageKey, JSON.stringify(data));
      } catch (e) {
        console.error('Fallback save error:', e);
      }
    }
  }

  // í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ìë™)
  async function loadDataFromCloud() {
    try {
      const storageKey = `overtime_${currentUser}_${currentYear}_${currentMonth}`;
      
      // window.storageê°€ ìˆìœ¼ë©´ í´ë¼ìš°ë“œì—ì„œ, ì—†ìœ¼ë©´ localStorageì—ì„œ
      let data = null;
      
      if (typeof window.storage !== 'undefined') {
        try {
          const result = await window.storage.get(storageKey, true);
          if (result && result.value) {
            data = JSON.parse(result.value);
          }
        } catch (e) {
          console.log('Cloud storage not available, trying localStorage');
        }
      }
      
      // fallback to localStorage
      if (!data) {
        const localData = localStorage.getItem(storageKey);
        if (localData) {
          data = JSON.parse(localData);
        }
      }
      
      if (!data || !data.rows) {
        // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ë‹¬ ìƒì„±
        checkIfNewMonth();
        initializeCurrentMonth();
        return;
      }
      
      if (data.year && data.month) {
        currentYear = data.year;
        currentMonth = data.month;
        updateMonthDisplay();
      }
      
      const tbody = document.querySelector("#workTable tbody");
      tbody.innerHTML = "";
      
      data.rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.date}</td>
          <td>${row.weekday}</td>
          <td><input type="text" class="work-input" value="${row.hours}"></td>
          <td>
            <select>
              <option ${row.type==='ì •ìƒ'?'selected':''}>ì •ìƒ</option>
              <option ${row.type==='ì—°ì°¨'?'selected':''}>ì—°ì°¨</option>
              <option ${row.type==='ì¬íƒ(ê¸ˆ)'?'selected':''}>ì¬íƒ(ê¸ˆ)</option>
              <option ${row.type==='íœ´ì¼'?'selected':''}>íœ´ì¼</option>
            </select>
          </td>`;
        const input = tr.querySelector("input");
        const select = tr.querySelector("select");
        input.addEventListener("blur", e => { e.target.value = normalizeTime(e.target.value); autoSave(); });
        input.addEventListener("input", () => autoSave());
        select.addEventListener("change", () => { updateType(tr); autoSave(); });
        tbody.appendChild(tr);
        updateType(tr);
      });
      
      calculate();
    } catch (error) {
      console.error('Load error:', error);
      initializeCurrentMonth();
    }
  }

  // ë‹¤ìŒ ë‹¬ë¡œ ë„˜ì–´ê°”ëŠ”ì§€ í™•ì¸í•˜ê³  ìë™ ì´ˆê¸°í™”
  function checkIfNewMonth() {
    if (!currentUser) return;
    
    const now = new Date();
    const thisYear = now.getFullYear();
    const thisMonth = now.getMonth() + 1;
    
    const lastVisitKey = `${currentUser}_lastVisit`;
    const lastVisit = localStorage.getItem(lastVisitKey);
    
    if (lastVisit) {
      const [lastYear, lastMonth] = lastVisit.split('-').map(Number);
      
      // ì›”ì´ ë°”ë€Œì—ˆìœ¼ë©´ ìë™ìœ¼ë¡œ í˜„ì¬ ì›”ë¡œ ì„¤ì •
      if (lastYear !== thisYear || lastMonth !== thisMonth) {
        currentYear = thisYear;
        currentMonth = thisMonth;
      }
    }
    
    // í˜„ì¬ ë°©ë¬¸ ê¸°ë¡ ì €ì¥
    localStorage.setItem(lastVisitKey, `${thisYear}-${thisMonth}`);
  }

  // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('userName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        login();
      }
    });
  });
</script>
</body>
</html>
